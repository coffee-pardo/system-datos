<script>
    // ===============================================================
    // 7. APP (Núcleo de la Aplicación)
    // ===============================================================

    /**
     * @description El objeto 'App' es el controlador principal de la aplicación.
     * Orquesta la inicialización, la carga de datos y el enlace de eventos.
     */
    const App = {
        /**
         * @description Método de inicialización. Es el punto de entrada de la lógica de la aplicación.
         */
        init() {
            console.log('🚀 Inicializando aplicación...');
            LoadingManager.show();

            // ✅ Inicializar Tooltips de Bootstrap
            new bootstrap.Tooltip(document.body, {
                selector: "[data-bs-toggle='tooltip']"
            });

            try {
                API.runServerFunction('getUserProfile', null, this.onProfileLoaded.bind(this), UI.handleError);
            } catch (error) {
                console.error('❌ Error en inicialización:', error);
                UI.handleError(error);
                LoadingManager.hide();
            }
        },

        /**
         * @description Obtiene las columnas disponibles para exportación según el rol del usuario.
         * @returns {Array} Array de objetos con información de las columnas.
         */
        getAvailableColumnsForExport() {
            const baseColumns = [
                { key: 'Ticket Interno', label: 'Ticket Interno', defaultSelected: true },
                { key: 'Pedido de escalamiento (Asunto)', label: 'Asunto del Ticket', defaultSelected: true }, // Alineado con el formulario
                { key: 'Planilla (Cliente)', label: 'Planilla Escalamiento', defaultSelected: true }, // Alineado con el formulario
                { key: 'Creado Por', label: 'Creado Por', defaultSelected: true },
                { key: 'Estado', label: 'Estado', defaultSelected: true },
                { key: 'Timestamp', label: 'Fecha de Creación', defaultSelected: true },
                { key: 'Herramienta', label: 'Herramienta', defaultSelected: false },
                { key: 'N° Caso Yoizen', label: 'N° Caso Yoizen', defaultSelected: false },
                { key: 'URL Adjunto', label: 'URL del Adjunto', defaultSelected: false },
                { key: 'ID Derivacion FAN', label: 'ID Derivación FAN', defaultSelected: false },
                { key: 'N° Ticket Escalamiento', label: 'N° Ticket Escalamiento', defaultSelected: false },
                { key: 'Prioridad', label: 'Prioridad', defaultSelected: true },
                { key: 'Tomado Por', label: 'Tomado Por', defaultSelected: true } // 🆕 NUEVO: Columna "Tomado Por"
            ];

            // 🆕 COLUMNAS ADICIONALES PARA SUPERUSUARIOS
            if (state.userProfile.role === 'SUPERUSER') {
                baseColumns.push(
                    { key: 'Observaciones Auditor', label: 'Observaciones del Auditor', defaultSelected: false }
                );
            }

            // 🆕 COLUMNAS ADICIONALES PARA AUDITORES
            if (state.userProfile.role === 'AUDITOR') {
                baseColumns.push(
                    { key: 'Observaciones Auditor', label: 'Observaciones del Auditor', defaultSelected: true }
                );
            }

            return baseColumns;
        },

        /**
         * @description Callback que se ejecuta cuando el perfil del usuario se ha cargado correctamente.
         * @param {object} profile - El objeto de perfil devuelto por el backend de Apps Script.
         */
        onProfileLoaded(profile) {
            console.log('👤 Perfil de usuario cargado:', profile);
            console.log('🖼️ URL de foto de perfil:', profile.photoUrl);

            if (!profile || !profile.email) {
                UI.handleError(new Error("No se pudo obtener el perfil del usuario. Asegúrese de haber concedido los permisos y despliegue una nueva versión."));
                LoadingManager.hide();
                return;
            }

            state.userProfile = profile;
            document.querySelector('#dropdownUser1 strong').textContent = profile.email.split('@')[0];
            UI.updateProfileImage(profile.photoUrl, profile.email);
            UI.applyPermissions();
            this.bindEvents();
            this.refreshData(); // Llama a refreshData sin opciones para cargar la primera página
            this.fetchNotifications(); // Cargar notificaciones al inicio
            this.fetchMotivosOperativos(); // 🆕 Cargar motivos operativos al inicio
            //NUEVO: Obtener y mostrar el superior del usuario
            API.runServerFunction('getUserSuperior', null,
                response => {
                    if (response.status === 'success' && response.superior) {
                        UI.displayUserSuperior(response.superior);
                    } else if (response.status === 'info') {
                        console.warn('ℹ️', response.message);
                        UI.displayUserSuperior('No asignado'); // O un mensaje por defecto
                    } else {
                        console.error('❌ Error al obtener el superior:', response.message);
                        UI.displayUserSuperior('Error');
                    }
                },
                error => {
                    console.error('❌ Error en la llamada a getUserSuperior:', error);
                    UI.displayUserSuperior('Error');
                }
            );
            // TERMINA NUEVO: Obtener y mostrar el superior del usuario  
        },

        /**
         * @description Callback que se ejecuta cuando los datos (tickets, clientes) se cargan correctamente.
         * @param {object} data - Objeto que contiene los arrays de tickets y clientes.
         */
        onDataLoaded(data) {
            console.log('📦 Datos recibidos:', data); // Debug

            if (!data || !Array.isArray(data.tickets)) {
                UI.handleError(new Error('La respuesta del servidor no es válida. Verifique la configuración del backend.'));
                LoadingManager.hide();
                return;
            }

            if (data.status === 'error') {
                UI.handleError(new Error(data.message));
                LoadingManager.hide();
                return;
            }

            // 🔧 FUNCIÓN AUXILIAR PARA SANITIZAR STRINGS - CORREGIDA
            const sanitizeString = (value) => {
                if (value === null || value === undefined || value === '') return '';
                if (typeof value === 'string') return value;
                return String(value);
            };

            // FUNCIÓN AUXILIAR PARA SANITIZAR FECHAS
            const sanitizeDate = (value) => {
                if (!value) return new Date();
                if (value instanceof Date) return value;
                const parsed = new Date(value);
                return isNaN(parsed.getTime()) ? new Date() : parsed;
            };

            // MAPEO ROBUSTO DE TICKETS PAGINADOS
            state.tickets = data.tickets.map(t => ({
                ticketInterno: sanitizeString(t['Ticket Interno']),
                pedido: sanitizeString(t['Pedido de escalamiento (Asunto)']), // Alineado
                planilla: sanitizeString(t['Planilla (Cliente)']), // Alineado
                creadoPor: sanitizeString(t['Creado Por']),
                estado: sanitizeString(t['Estado']) || 'Registrado',
                timestamp: sanitizeDate(t['Timestamp']),
                herramienta: sanitizeString(t['Herramienta']),
                casoYoizen: sanitizeString(t['N° Caso Yoizen']),
                adjuntoUrl: sanitizeString(t['URL Adjunto']),
                idDerivacion: sanitizeString(t['ID Derivacion FAN']),
                numeroTicket: sanitizeString(t['N° Ticket Escalamiento']),
                observacionesAuditor: sanitizeString(t['Observaciones Auditor']),
                prioridad: sanitizeString(t['Prioridad']) || 'Normal',
                tomadoPor: sanitizeString(t['Tomado Por']) // 🆕 NUEVO: Campo "Tomado Por"
            }));

            // MAPEO ROBUSTO DE TODOS LOS TICKETS PARA ESTADÍSTICAS
            state.allTicketsForStats = (data.allTicketsForStats || []).map(t => ({
                ticketInterno: sanitizeString(t['Ticket Interno']),
                pedido: sanitizeString(t['Pedido de escalamiento (Asunto)']),
                planilla: sanitizeString(t['Planilla (Cliente)']),
                creadoPor: sanitizeString(t['Creado Por']),
                estado: sanitizeString(t['Estado']) || 'Registrado',
                timestamp: sanitizeDate(t['Timestamp']),
                herramienta: sanitizeString(t['Herramienta']),
                casoYoizen: sanitizeString(t['N° Caso Yoizen']),
                adjuntoUrl: sanitizeString(t['URL Adjunto']),
                idDerivacion: sanitizeString(t['ID Derivacion FAN']),
                numeroTicket: sanitizeString(t['N° Ticket Escalamiento']),
                observacionesAuditor: sanitizeString(t['Observaciones Auditor']),
                prioridad: sanitizeString(t['Prioridad']) || 'Normal',
                tomadoPor: sanitizeString(t['Tomado Por']) // 🆕 NUEVO: Campo "Tomado Por"
            }));

            // Actualizar paginación
            state.pagination.totalTickets = data.totalTickets || 0;
            state.pagination.totalPages = Math.ceil(state.pagination.totalTickets / state.pagination.pageSize);

            // SANITIZAR ARRAYS DE PLANILLAS Y CREADORES
            state.allPlanillas = (data.allPlanillas || []).filter(planilla => planilla && planilla.trim() !== '').sort(); // 🆕 RENOMBRADO
            state.allCreators = (data.allCreators || []).filter(creator => creator && creator.trim() !== '').sort();
            state.allSuperiores = (data.allSuperiores || []).filter(superior => superior && superior.trim() !== '').sort(); // 🆕 NUEVO

            console.log('✅ Datos procesados. Total tickets:', state.tickets.length); // Debug
            console.log('✅ Total tickets para stats:', state.allTicketsForStats.length); // Debug
            console.log('✅ Superiores disponibles:', state.allSuperiores.length); // 🆕 NUEVO
            console.log('✅ Mostrando vista:', state.currentView); // Debug

            Router.showView(state.currentView);
            LoadingManager.hide();
        },

        /**
         * @description Función para forzar una recarga de los datos desde el servidor.
         * @param {Object} [options={}] - Opciones de paginación y filtrado.
         */
        refreshData(options = {}) {
            LoadingManager.show();
            const currentOptions = {
                page: state.pagination.currentPage,
                pageSize: state.pagination.pageSize,
                searchQuery: state.filters.searchQuery,
                filterStatus: state.filters.status,
                filterTool: state.filters.tool,
                filterMotivoEscalamiento: state.filters.motivoEscalamiento, // 🆕 RENOMBRADO
                filterCreatedBy: state.filters.createdBy,
                filterEquipo: state.filters.equipo, // 🆕 NUEVO: Incluir filtro por equipo
                startDate: state.filters.startDate,
                endDate: state.filters.endDate,
                filterPriority: state.filters.priority,
                ...options
            };
            API.runServerFunction('getDashboardData', currentOptions, this.onDataLoaded.bind(this), UI.handleError);
        },

        /**
         * @description Obtiene las notificaciones no leídas del servidor.
         */
        fetchNotifications() {
            API.runServerFunction('getUnreadNotifications', null,
                response => {
                    if (response.status === 'ok') {
                        state.notifications = response.notifications;
                        UI.renderNotificationSummary();
                    } else {
                        UI.handleError(new Error(response.message || 'Error al cargar notificaciones.'));
                    }
                },
                error => {
                    UI.handleError(error);
                }
            );
        },

        /**
         * 🆕 Obtiene todos los motivos operativos de la hoja "Planillas_Master" para el datalist.
         */
        fetchMotivosOperativos() {
            API.runServerFunction('getAllMotivosOperativos', null,
                response => {
                    if (Array.isArray(response)) {
                        state.motivosOperativos = response;
                        UI.populateMotivoEscalamientoDatalist(response);
                    } else {
                        console.error('❌ Respuesta inesperada al obtener motivos operativos:', response);
                    }
                },
                error => {
                    console.error('❌ Error al obtener motivos operativos:', error);
                    UI.handleError(error);
                }
            );
        },

        /**
         * @description Centraliza la asignación de todos los 'event listeners' de la aplicación.
         */
        bindEvents() {
            // BOT
            const fab = document.getElementById('fabButton');
            const panel = document.getElementById('right-side-panel');
            const overlay = document.getElementById('side-panel-overlay');
            const closeBtn = document.getElementById('close-side-panel');

            const openPanel = () => {
                panel?.classList.add('open');
                overlay?.classList.add('show');
            };

            const closePanel = () => {
                panel?.classList.remove('open');
                overlay?.classList.remove('show');
            };

            fab?.addEventListener('click', (e) => {
                e.preventDefault();
                if (panel?.classList.contains('open')) {
                    closePanel();
                } else {
                    openPanel();
                }
            });

            closeBtn?.addEventListener('click', closePanel);
            overlay?.addEventListener('click', closePanel);

            document.addEventListener('keydown', (ev) => {
                if (ev.key === 'Escape' && panel?.classList.contains('open')) {
                    closePanel();
                }
            });

            // ✅ NUEVO: Lógica para el botón flotante de herramientas
            const toolsFabContainer = document.getElementById('tools-fab-container');
            const toolsFabButton = document.getElementById('toolsFabButton');

            toolsFabButton?.addEventListener('click', (e) => {
                e.stopPropagation(); // Evita que el clic se propague al documento
                toolsFabContainer.classList.toggle('open');
            });

            // Cierra el menú de herramientas si se hace clic en cualquier otro lugar
            document.addEventListener('click', (e) => {
                if (toolsFabContainer?.classList.contains('open') && !toolsFabContainer.contains(e.target)) {
                    toolsFabContainer.classList.remove('open');
                }
            });


            console.log('🔗 Enlazando eventos...');

            const sidebarNav = document.getElementById('sidebar-nav');
            if (sidebarNav) {
                sidebarNav.addEventListener('click', Handlers.handleNavigation);
                console.log('✅ Evento de navegación enlazado');
            }

            const viewAllBtn = document.getElementById('view-all-tickets-btn');
            if (viewAllBtn) {
                viewAllBtn.addEventListener('click', () => {
                    console.log('🎯 Click en Ver todos');
                    Router.showView('tickets');
                });
                console.log('✅ Evento Ver todos enlazado');
            }

            document.getElementById('darkModeSwitch')?.addEventListener('change', UI.toggleDarkMode);
            document.getElementById('search-input')?.addEventListener('input', Handlers.handleSearch);
            document.getElementById('escalamientoForm')?.addEventListener('submit', Handlers.handleTicketSubmit);
            document.getElementById('export-to-excel-btn')?.addEventListener('click', Handlers.handleExport);

            ['modalNuevoTicket', 'modalDetalleTicket', 'modalReporte'].forEach(id => {
                document.getElementById(id)?.addEventListener('show.bs.modal', Handlers.handleModalOpen);
            });

            document.getElementById('modalMetricasUsuario')?.addEventListener('show.bs.modal', UI.renderUserMetricsModal.bind(UI));
            document.getElementById('sidebarToggle')?.addEventListener('click', UI.toggleSidebar);

            // Event listeners para filtros
            document.getElementById('tickets-filter-status')?.addEventListener('change', Handlers.handleFilterChange);
            document.getElementById('tickets-filter-tool')?.addEventListener('change', Handlers.handleFilterChange);
            document.getElementById('tickets-filter-motivoEscalamiento')?.addEventListener('change', Handlers.handleFilterChange); // 🆕 RENOMBRADO
            document.getElementById('tickets-filter-createdBy')?.addEventListener('change', Handlers.handleFilterChange);
            document.getElementById('tickets-filter-equipo')?.addEventListener('change', Handlers.handleFilterChange); // 🆕 NUEVO
            document.getElementById('tickets-filter-startDate')?.addEventListener('change', Handlers.handleFilterChange);
            document.getElementById('tickets-filter-endDate')?.addEventListener('change', Handlers.handleFilterChange);
            document.getElementById('tickets-filter-priority')?.addEventListener('change', Handlers.handleFilterChange);
            document.getElementById('tickets-clear-filters-btn')?.addEventListener('click', Handlers.handleClearFilters);
            document.getElementById('tickets-pagination')?.addEventListener('click', Handlers.handlePaginationClick);

            // Panel de Gestión Rápida
            document.getElementById('quick-manage-filter-status')?.addEventListener('change', Handlers.handleQuickManageFilterChange);
            document.getElementById('quick-manage-filter-priority')?.addEventListener('change', Handlers.handleQuickManageFilterChange);
            document.getElementById('quick-manage-clear-filters-btn')?.addEventListener('click', Handlers.handleQuickManageClearFilters);
            document.getElementById('quick-manage-pagination')?.addEventListener('click', Handlers.handleQuickManagePaginationClick);

            // 🆕 NUEVO: Event listener para el botón "Tomar Ticket"
            document.getElementById('take-ticket-btn')?.addEventListener('click', Handlers.handleTakeTicket);

            // 🆕 NUEVO: Event listener para el campo Motivo de Escalamiento
            document.getElementById('motivoEscalamiento')?.addEventListener('change', Handlers.handleMotivoEscalamientoChange);
            document.getElementById('motivoEscalamiento')?.addEventListener('blur', Handlers.handleMotivoEscalamientoChange);
            // Empieza IAAAAAAAAAAAAAAAA
            document.getElementById('chat-send-btn')?.addEventListener('click', Handlers.handleBotQuery);
            document.getElementById('chat-input')?.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    Handlers.handleBotQuery();
                }
            });
            // TERMINA IAAAAAAAAAAAAAAAA
        },
    };


    // ===============================================================
    // 8. INICIALIZACIÓN
    // ===============================================================

    document.addEventListener('DOMContentLoaded', () => {
        window.UI = UI;
        window.Handlers = Handlers;
        window.LoadingManager = LoadingManager;

        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
            const switchInput = document.getElementById('darkModeSwitch');
            if (switchInput) {
                switchInput.checked = true;
            }
        }

        console.log('🎯 Iniciando aplicación TechSupport Pro...');
        App.init();
    });
</script>