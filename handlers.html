<script>
    // ===============================================================
    // 6. HANDLERS (Manejadores de Eventos)
    // ===============================================================

    /**
     * @description El objeto 'Handlers' contiene las funciones que se ejecutan en respuesta a eventos del usuario.
     */
    const Handlers = {

        /**
        * üÜï Maneja el cambio en el switch "Mis Tickets".
        * @param {Event} event - El objeto del evento de cambio.
        */
        handleMyTicketsFilterChange(event) {
            state.isMyTicketsFilterActive = event.target.checked;
            state.pagination.currentPage = 1; // Resetear paginaci√≥n al cambiar el filtro
            App.refreshData(); // Recargar datos con el nuevo filtro
        },

        // IAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
        handleBotQuery() {
            const input = document.getElementById('chat-input');
            const query = input.value.trim();
            if (!query) return;

            UI.addChatMessage('user', query);
            input.value = '';
            input.disabled = true;
            document.getElementById('chat-send-btn').disabled = true;
            UI.showBotTyping(true);

            const onSuccess = (response) => {
                UI.showBotTyping(false);
                UI.addChatMessage('bot', response);
                input.disabled = false;
                document.getElementById('chat-send-btn').disabled = false;
                input.focus();
            };

            const onFailure = (error) => {
                UI.showBotTyping(false);
                UI.addChatMessage('error', `Error: ${error.message}`);
                input.disabled = false;
                document.getElementById('chat-send-btn').disabled = false;
                input.focus();
            };

            API.runServerFunction('getBotResponse', query, onSuccess, onFailure);
        },
        // TERMINA    IAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA

        /**
         * üÜï Maneja los cambios en los filtros del Panel de Gesti√≥n R√°pida.
         * @param {Event} event - El objeto del evento de cambio.
         */
        handleQuickManageFilterChange() {
            state.quickManageFilters.status = document.getElementById('quick-manage-filter-status')?.value || '';
            state.quickManageFilters.priority = document.getElementById('quick-manage-filter-priority')?.value || '';
            state.quickManagePagination.currentPage = 1;
            UI.renderQuickManagePanel();
        },

        /**
         * üÜï Limpia todos los filtros del Panel de Gesti√≥n R√°pida.
         */
        handleQuickManageClearFilters() {
            document.getElementById('quick-manage-filter-status').value = '';
            document.getElementById('quick-manage-filter-priority').value = '';
            state.quickManageFilters = { status: '', priority: '' };
            state.quickManagePagination.currentPage = 1;
            UI.renderQuickManagePanel();
        },

        /**
         * üÜï Maneja los clics en los controles de paginaci√≥n del Panel de Gesti√≥n R√°pida.
         * @param {Event} event - El objeto del evento de clic.
         */
        handleQuickManagePaginationClick(event) {
            event.preventDefault();
            const target = event.target.closest('.page-link');
            if (!target) return;

            const pageAction = target.dataset.page;
            let newPage = state.quickManagePagination.currentPage;

            if (pageAction === 'prev') {
                newPage = Math.max(1, newPage - 1);
            } else if (pageAction === 'next') {
                newPage = Math.min(state.quickManagePagination.totalPages, newPage + 1);
            } else {
                newPage = parseInt(pageAction);
            }

            if (newPage !== state.quickManagePagination.currentPage) {
                state.quickManagePagination.currentPage = newPage;
                UI.renderQuickManagePanel();
            }
        },

        /**
         * üÜï Maneja la actualizaci√≥n de estado, observaciones o prioridad desde el Panel de Gesti√≥n R√°pida.
         * @param {string} ticketId - El ID del ticket.
         * @param {string} type - 'status', 'priority', 'observations'.
         * @param {string} value - El nuevo valor.
         */
        handleQuickManageUpdate(ticketId, type, value) {
            const ticket = state.allTicketsForStats.find(t => t.ticketInterno === ticketId);
            if (!ticket) return;

            let updateParams = { ticketId: ticketId };
            let successMessage = '';

            if (type === 'status') {
                updateParams.newStatus = value;
                successMessage = `Estado de ${ticketId} actualizado a ${value}`;
            } else if (type === 'priority') {
                updateParams.newPriority = value;
                successMessage = `Prioridad de ${ticketId} actualizada a ${value}`;
            } else if (type === 'observations') {
                updateParams.newObservations = value;
                successMessage = `Observaciones de ${ticketId} actualizadas`;
            }

            API.runServerFunction('updateTicketStatus', updateParams,
                response => {
                    if (response.status === 'success') {
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 2000,
                            timerProgressBar: true,
                            icon: 'success',
                            title: successMessage
                        });
                        App.refreshData();
                        UI.renderQuickManagePanel();
                        App.fetchNotifications();
                    } else if (response.status === 'info') {
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 2000,
                            timerProgressBar: true,
                            icon: 'info',
                            title: response.message
                        });
                    } else {
                        UI.handleError(new Error(response.message || 'Error al actualizar el ticket.'));
                    }
                },
                UI.handleError
            );
        },

        /**
         * @description Maneja los clics en la barra de navegaci√≥n lateral (sidebar).
         * @param {Event} event - El objeto del evento de clic.
         */
        handleNavigation(event) {
            console.log('üñ±Ô∏è Click en navegaci√≥n');
            const navLink = event.target.closest('.nav-link');

            if (navLink && navLink.dataset.view) {
                event.preventDefault();
                console.log('üìç Navegando a:', navLink.dataset.view);
                Router.showView(navLink.dataset.view);
            }
        },

        /**
         * @description Filtra los tickets en tiempo real mientras el usuario escribe en la barra de b√∫squeda.
         * @param {Event} event - El objeto del evento de input.
         */
        handleSearch(event) {
            state.filters.searchQuery = event.target.value;
            state.pagination.currentPage = 1;
            App.refreshData();

            const modalAuditoria = document.getElementById('modalMetricasUsuario');
            if (modalAuditoria && modalAuditoria.classList.contains('show')) {
                UI.renderQuickManagePanel();
            }
        },

        /**
         * @description Maneja los cambios en los filtros avanzados de tickets.
         * @param {Event}  event - El objeto del evento de cambio.
         */
        handleFilterChange() {
            state.filters.status = document.getElementById('tickets-filter-status')?.value || '';
            state.filters.tool = document.getElementById('tickets-filter-tool')?.value || '';
            state.filters.motivoEscalamiento = document.getElementById('tickets-filter-motivoEscalamiento')?.value || ''; // üÜï RENOMBRADO
            state.filters.createdBy = document.getElementById('tickets-filter-createdBy')?.value || '';
            state.filters.equipo = document.getElementById('tickets-filter-equipo')?.value || ''; // üÜï NUEVO
            state.filters.startDate = document.getElementById('tickets-filter-startDate')?.value || '';
            state.filters.endDate = document.getElementById('tickets-filter-endDate')?.value || '';
            state.filters.priority = document.getElementById('tickets-filter-priority')?.value || '';
            state.pagination.currentPage = 1;
            App.refreshData();
        },

        /**
         * @description Limpia todos los filtros avanzados de tickets.
         */
        handleClearFilters() {
            document.getElementById('tickets-filter-status').value = '';
            document.getElementById('tickets-filter-tool').value = '';
            document.getElementById('tickets-filter-motivoEscalamiento').value = ''; // üÜï RENOMBRADO
            document.getElementById('tickets-filter-createdBy').value = '';
            document.getElementById('tickets-filter-equipo').value = ''; // üÜï NUEVO
            document.getElementById('tickets-filter-startDate').value = '';
            document.getElementById('tickets-filter-endDate').value = '';
            document.getElementById('tickets-filter-priority').value = '';
            state.filters = {
                searchQuery: state.filters.searchQuery,
                status: '', tool: '', motivoEscalamiento: '', createdBy: '', equipo: '', startDate: '', endDate: '', priority: '' // üÜï RENOMBRADO
            };
            state.pagination.currentPage = 1;
            App.refreshData();
        },

        /**
         * @description Maneja los clics en los controles de paginaci√≥n.
         * @param {Event} event - El objeto del evento de clic.
         */
        handlePaginationClick(event) {
            event.preventDefault();
            const target = event.target.closest('.page-link');
            if (!target) return;

            const pageAction = target.dataset.page;
            let newPage = state.pagination.currentPage;

            if (pageAction === 'prev') {
                newPage = Math.max(1, newPage - 1);
            } else if (pageAction === 'next') {
                newPage = Math.min(state.pagination.totalPages, newPage + 1);
            } else {
                newPage = parseInt(pageAction);
            }

            if (newPage !== state.pagination.currentPage) {
                state.pagination.currentPage = newPage;
                App.refreshData();
            }
        },

        /**
         * @description Maneja el env√≠o del formulario de creaci√≥n de un nuevo ticket.
         * @param {Event} event - El objeto del evento de submit.
         */
        handleTicketSubmit(event) {
            event.preventDefault();
            const form = event.target;

            // üÜï VALIDACI√ìN MEJORADA DE INPUTS DEL FORMULARIO
            let isValid = true;
            const requiredFields = [
                'usuario', 'casoYoizen', 'herramienta', 'planilla', 'motivoEscalamiento', 'idDerivacion'
            ];

            requiredFields.forEach(fieldId => {
                const input = form.elements[fieldId];
                if (input && input.value.trim() === '') {
                    input.classList.add('is-invalid');
                    isValid = false;
                } else {
                    input.classList.remove('is-invalid');
                }
            });

            if (!isValid) {
                UI.showAlert('alertPlaceholderTicket', 'Por favor, completa todos los campos obligatorios.', 'danger');
                return;
            }

            Swal.fire({
                title: '¬øEst√°s seguro?',
                text: "El ticket ser√° enviado para su procesamiento.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'S√≠, ¬°enviar!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    const button = document.getElementById('submitTicketButton');
                    UI.toggleButtonSpinner(button, true);

                    const onSuccess = (response) => {
                        UI.toggleButtonSpinner(button, false);
                        if (response.status === 'success') {
                            Swal.fire('¬°Enviado!', `El ticket #${response.ticket} ha sido creado.`, 'success');
                            bootstrap.Modal.getInstance(document.getElementById('modalNuevoTicket')).hide();
                            form.reset();
                            form.classList.remove('was-validated'); // Asegurar que se quita la validaci√≥n visual
                            // Limpiar clases de validaci√≥n manuales
                            requiredFields.forEach(fieldId => {
                                const input = form.elements[fieldId];
                                if (input) input.classList.remove('is-invalid');
                            });
                            App.refreshData();
                            App.fetchNotifications();
                        } else {
                            UI.showAlert('alertPlaceholderTicket', response.message || 'Ocurri√≥ un error desconocido.', 'danger');
                        }
                    };

                    const onFailure = (error) => {
                        UI.toggleButtonSpinner(button, false);
                        UI.handleError(error);
                        UI.showAlert('alertPlaceholderTicket', error.message, 'danger');
                    };

                    const formData = {
                        usuario: form.elements['usuario'].value,
                        casoYoizen: form.elements['casoYoizen'].value,
                        herramienta: form.elements['herramienta'].value,
                        planilla: form.elements['planilla'].value,
                        motivoEscalamiento: form.elements['motivoEscalamiento'].value,
                        idDerivacion: form.elements['idDerivacion'].value,
                        numeroTicket: form.elements['numeroTicket'].value
                    };

                    const fileInput = document.getElementById('capturaFile');
                    const file = fileInput.files[0];

                    const runCreateTicket = (submissionData) => {
                        API.runServerFunction('createTicket', submissionData, onSuccess, onFailure);
                    };

                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const fileData = {
                                fileName: file.name,
                                fileType: file.type,
                                fileContent: e.target.result
                            };
                            runCreateTicket({ ...formData, ...fileData });
                        };
                        reader.readAsDataURL(file);
                    } else {
                        runCreateTicket(formData);
                    }
                }
            });
        },

        /**
         * @description Maneja la actualizaci√≥n de observaciones de un ticket.
         * @param {string} ticketId - El ID del ticket.
         * @param {string} newObservations - Las nuevas observaciones.
         */
        handleTicketObservationsUpdate(ticketId, newObservations) {
            API.runServerFunction('updateTicketStatus', { ticketId: ticketId, newObservations: newObservations },
                response => {
                    if (response.status === 'success') {
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 2000,
                            timerProgressBar: true,
                            icon: 'success',
                            title: `Observaciones del Ticket ${ticketId} actualizadas`
                        });
                        App.refreshData();
                    } else if (response.status === 'info') {
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 2000,
                            timerProgressBar: true,
                            icon: 'info',
                            title: response.message
                        });
                        App.refreshData();
                    } else {
                        UI.handleError(new Error(response.message || 'Error al actualizar observaciones.'));
                    }
                },
                UI.handleError
            );
        },

        /**
         * üÜï Maneja la actualizaci√≥n de la prioridad de un ticket.
         * @param {string} ticketId - El ID del ticket.
         * @param {string} newPriority - La nueva prioridad.
         */
        handleTicketPriorityUpdate(ticketId, newPriority) {
            API.runServerFunction('updateTicketStatus', { ticketId: ticketId, newPriority: newPriority },
                response => {
                    if (response.status === 'success') {
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 2000,
                            timerProgressBar: true,
                            icon: 'success',
                            title: `Prioridad del Ticket ${ticketId} actualizada a ${newPriority}`
                        });
                        App.refreshData();
                    } else if (response.status === 'info') {
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 2000,
                            timerProgressBar: true,
                            icon: 'info',
                            title: response.message
                        });
                        App.refreshData();
                    } else {
                        UI.handleError(new Error(response.message || 'Error al actualizar prioridad.'));
                    }
                },
                UI.handleError
            );
        },

        /**
         * üÜï Maneja la acci√≥n de "Tomar Ticket" por un auditor/superuser.
         */
        handleTakeTicket() {
            const ticketId = document.getElementById('detalle-ticket-id').textContent.replace('#', '');
            if (!ticketId) {
                UI.showAlert('alertPlaceholderComments', 'No se pudo obtener el ID del ticket.', 'danger');
                return;
            }

            Swal.fire({
                title: '¬øTomar este ticket?',
                text: `Se registrar√° que has tomado el ticket ${ticketId} para auditor√≠a.`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'S√≠, tomarlo',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    const button = document.getElementById('take-ticket-btn');
                    UI.toggleButtonSpinner(button, true);

                    API.runServerFunction('takeTicket', { ticketId: ticketId },
                        response => {
                            UI.toggleButtonSpinner(button, false);
                            if (response.status === 'success') {
                                Swal.fire({
                                    toast: true,
                                    position: 'top-end',
                                    showConfirmButton: false,
                                    timer: 2000,
                                    timerProgressBar: true,
                                    icon: 'success',
                                    title: response.message
                                });
                                // Actualizar el modal de detalle y los datos globales
                                App.refreshData();
                                // Buscar el ticket actualizado en el estado y re-renderizar el modal
                                const updatedTicket = state.allTicketsForStats.find(t => t.ticketInterno === ticketId);
                                if (updatedTicket) {
                                    UI.renderTicketDetailModal(updatedTicket);
                                }
                            } else {
                                UI.handleError(new Error(response.message || 'Error al tomar el ticket.'));
                            }
                        },
                        error => {
                            UI.toggleButtonSpinner(button, false);
                            UI.handleError(error);
                        }
                    );
                }
            });
        },

        /**
         * üÜï Maneja el cambio o blur en el campo "Motivo de Escalamiento" para buscar la planilla.
         * @param {Event} event - El objeto del evento.
         */
        handleMotivoEscalamientoChange(event) {
            const motivoInput = event.target;
            const motivo = motivoInput.value.trim();
            const planillaInput = document.getElementById('planilla');
            const rutaOperativaInput = document.getElementById('rutaOperativa'); // NUEVO: Obtener el campo de ruta operativa

            if (motivo) {
                // Buscar Planilla Operativa
                API.runServerFunction('getPlanillaOperativaByMotivo', motivo,
                    response => {
                        if (response) {
                            planillaInput.value = response;
                        } else {
                            planillaInput.value = '';
                        }
                    },
                    error => {
                        console.error('Error al buscar planilla operativa:', error);
                        UI.handleError(error);
                        planillaInput.value = '';
                    }
                );

                // NUEVO: Buscar Ruta Operativa
                API.runServerFunction('getRutaOperativaByMotivo', motivo,
                    response => {
                        if (response) {
                            rutaOperativaInput.value = response;
                        } else {
                            rutaOperativaInput.value = 'No se encontr√≥ una ruta operativa asociada a este motivo.';
                        }
                    },
                    error => {
                        console.error('Error al buscar ruta operativa:', error);
                        UI.handleError(error);
                        rutaOperativaInput.value = 'Error al buscar la ruta operativa.';
                    }
                );

            } else {
                planillaInput.value = ''; // Limpiar si el motivo est√° vac√≠o
                rutaOperativaInput.value = ''; // NUEVO: Limpiar si el motivo est√° vac√≠o
            }
        },

        /**
         * @description Maneja el env√≠o de un nuevo comentario para un ticket.
         * @param {string} ticketId - El ID del ticket al que se a√±ade el comentario.
         */
        handleCommentSubmit(ticketId) {
            const commentInput = document.getElementById('new-comment-text');
            const commentText = commentInput.value.trim();

            if (!commentText) {
                UI.showAlert('alertPlaceholderComments', 'El comentario no puede estar vac√≠o.', 'warning');
                return;
            }

            const submitButton = document.getElementById('submitCommentButton');
            UI.toggleButtonSpinner(submitButton, true);

            const commentData = {
                ticketId: ticketId,
                commentText: commentText
            };

            API.runServerFunction('addTicketComment', commentData,
                response => {
                    UI.toggleButtonSpinner(submitButton, false);

                    if (response.status === 'success') {
                        commentInput.value = '';

                        if (Swal.isVisible()) {
                            Swal.close();
                        }

                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 2000,
                            timerProgressBar: true,
                            icon: 'success',
                            title: 'Comentario a√±adido',
                            backdrop: false,
                            allowOutsideClick: true,
                            allowEscapeKey: true
                        });

                        const commentsContainer = document.getElementById('ticket-comments-list');
                        commentsContainer.innerHTML = '<div class="text-center text-muted fst-italic">Cargando comentarios...</div>';

                        API.runServerFunction('getTicketComments', ticketId,
                            commentResponse => {
                                if (commentResponse.status === 'ok') {
                                    state.comments[ticketId] = commentResponse.comments;
                                    if (commentResponse.comments.length === 0) {
                                        commentsContainer.innerHTML = '<div class="text-center text-muted fst-italic">No hay comentarios a√∫n.</div>';
                                    } else {
                                        commentsContainer.innerHTML = commentResponse.comments.map(c => `
                                            <div class="comment-item mb-2 p-2 border rounded">
                                                <small class="text-muted">${c.autor} - ${new Date(c.timestamp).toLocaleString()}</small>
                                                <p class="mb-0">${c.comentario}</p>
                                            </div>
                                        `).join('');
                                    }
                                } else {
                                    commentsContainer.innerHTML = `<div class="alert alert-danger">Error al cargar comentarios: ${commentResponse.message}</div>`;
                                }
                            },
                            error => {
                                commentsContainer.innerHTML = `<div class="alert alert-danger">Error del servidor: ${error.message}</div>`;
                            }
                        );

                    } else {
                        UI.showAlert('alertPlaceholderComments', response.message || 'Error al a√±adir comentario.', 'danger');
                    }
                },
                error => {
                    UI.toggleButtonSpinner(submitButton, false);
                    UI.handleError(error);
                    UI.showAlert('alertPlaceholderComments', error.message, 'danger');
                }
            );
        },

        /**
         * @description Se ejecuta cuando se abre cualquier modal para limpiar su estado previo.
         * @param {Event} event - El evento 'show.bs.modal' de Bootstrap.
         */
        handleModalOpen(event) {
            const form = event.target.querySelector('form');
            if (form) {
                form.classList.remove('was-validated');
                form.reset();
                // Limpiar clases de validaci√≥n manuales
                const requiredFields = [
                    'usuario', 'casoYoizen', 'herramienta', 'planilla', 'motivoEscalamiento', 'idDerivacion'
                ];
                requiredFields.forEach(fieldId => {
                    const input = form.elements[fieldId];
                    if (input) input.classList.remove('is-invalid');
                });
            }

            const placeholder = event.target.querySelector('[id^="alertPlaceholder"]');
            if (placeholder) {
                placeholder.innerHTML = '';
            }

            if (event.target.id === 'modalMetricasUsuario') {
                UI.renderUserMetricsModal();

                document.getElementById('quick-manage-filter-status').value = '';
                document.getElementById('quick-manage-filter-priority').value = '';
                state.quickManageFilters = { status: '', priority: '' };
                state.quickManagePagination.currentPage = 1;

                UI.renderQuickManagePanel();
            }
        },

        /**
         * @description Maneja el clic en una fila de la tabla de tickets para mostrar sus detalles.
         * @param {string} ticketId - El ID del ticket en la fila clickeada.
         */
        handleTicketRowClick(ticketId) {
            const ticket = state.tickets.find(t => t.ticketInterno === ticketId) ||
                state.allTicketsForStats.find(t => t.ticketInterno === ticketId);
            if (ticket) {
                UI.renderTicketDetailModal(ticket);
                const modal = new bootstrap.Modal(document.getElementById('modalDetalleTicket'));
                modal.show();
            }
        },

        /**
         * @description Maneja la solicitud de exportar los tickets a un archivo Excel.
         */
        handleExport() {
            if (state.userProfile.role !== 'SUPERUSER' && state.userProfile.role !== 'AUDITOR') {
                Swal.fire({
                    title: 'Acceso Denegado',
                    text: 'No tienes permisos para exportar datos. Esta funcionalidad est√° restringida a Auditores y Superusuarios.',
                    icon: 'error',
                    confirmButtonText: 'Entendido'
                });
                return;
            }

            const exportModal = new bootstrap.Modal(document.getElementById('modalExportTickets'));
            exportModal.show();

            const columnsSelect = document.getElementById('export-columns');
            columnsSelect.innerHTML = '';

            const availableColumns = App.getAvailableColumnsForExport();

            availableColumns.forEach(column => {
                const option = document.createElement('option');
                option.value = column.key;
                option.textContent = column.label;
                option.selected = column.defaultSelected;
                columnsSelect.appendChild(option);
            });

            document.getElementById('export-excel-btn').onclick = () => {
                if (state.userProfile.role !== 'SUPERUSER' && state.userProfile.role !== 'AUDITOR') {
                    Swal.fire('Error de Seguridad', 'Acceso no autorizado detectado.', 'error');
                    exportModal.hide();
                    return;
                }

                const selectedColumns = Array.from(columnsSelect.selectedOptions).map(option => option.value);
                const startDate = document.getElementById('export-start-date').value;
                const endDate = document.getElementById('export-end-date').value;

                if (selectedColumns.length === 0) {
                    Swal.fire('Error', 'Debes seleccionar al menos una columna para exportar.', 'warning');
                    return;
                }

                Swal.fire({
                    title: 'Exportando tickets...',
                    text: 'Esto puede tardar unos segundos.',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();

                        const exportParams = {
                            columns: selectedColumns,
                            startDate: startDate,
                            endDate: endDate,
                            userRole: state.userProfile.role,
                            requestedBy: state.userProfile.email
                        };

                        API.runServerFunction('exportTicketsToExcel', exportParams,
                            response => {
                                Swal.close();
                                exportModal.hide();

                                if (response.status === 'success' && response.fileUrl) {
                                    Swal.fire({
                                        title: '¬°Exportaci√≥n Exitosa!',
                                        text: 'El archivo Excel ha sido generado y est√° listo para descargar.',
                                        icon: 'success',
                                        showCancelButton: true,
                                        confirmButtonText: 'Descargar Archivo',
                                        cancelButtonText: 'Cerrar'
                                    }).then((result) => {
                                        if (result.isConfirmed) {
                                            window.open(response.fileUrl, '_blank');
                                        }
                                    });
                                } else {
                                    Swal.fire('Error', response.message || 'No se pudo exportar el archivo.', 'error');
                                }
                            },
                            error => {
                                Swal.close();
                                exportModal.hide();
                                UI.handleError(error);
                                Swal.fire('Error', error.message || 'Ocurri√≥ un error al exportar.', 'error');
                            }
                        );
                    }
                });
            };
        },

        /**
         * @description Maneja el clic en una notificaci√≥n para marcarla como le√≠da.
         * @param {Event} event - El objeto del evento de clic.
         */
        handleNotificationClick(event) {
            const notificationItem = event.target.closest('.notification-item-dashboard');

            if (notificationItem) {
                event.preventDefault();
                event.stopPropagation();

                const row = parseInt(notificationItem.dataset.notificationRow);
                const ticketId = notificationItem.dataset.ticketId;

                console.log(`üîî Clic en notificaci√≥n - Row: ${row}, TicketId: "${ticketId}"`);

                API.runServerFunction('markNotificationAsRead', row,
                    response => {
                        if (response.status === 'success') {
                            console.log('‚úÖ Notificaci√≥n marcada como le√≠da');
                            App.fetchNotifications();

                            if (ticketId && ticketId.trim() !== '') {
                                console.log(`üéØ Filtrando por ticket: "${ticketId}"`);

                                Router.showView('tickets');

                                const searchInput = document.getElementById('search-input');
                                if (searchInput) {
                                    searchInput.value = ticketId;
                                }

                                state.filters.searchQuery = ticketId;
                                state.pagination.currentPage = 1;

                                Swal.fire({
                                    title: 'Buscando ticket...',
                                    text: `Filtrando por ticket ${ticketId}`,
                                    allowOutsideClick: false,
                                    showConfirmButton: false,
                                    didOpen: () => {
                                        Swal.showLoading();
                                    }
                                });

                                App.refreshData({
                                    searchQuery: ticketId,
                                    page: 1,
                                    pageSize: 10
                                });

                                setTimeout(() => {
                                    Swal.close();

                                    const foundTicket = state.tickets.find(t => t.ticketInterno === ticketId) ||
                                        (state.allTicketsForStats && state.allTicketsForStats.find(t => t.ticketInterno === ticketId));

                                    if (foundTicket) {
                                        console.log('‚úÖ Ticket encontrado despu√©s del filtro, abriendo modal');

                                        setTimeout(() => {
                                            UI.renderTicketDetailModal(foundTicket);
                                            const modal = new bootstrap.Modal(document.getElementById('modalDetalleTicket'));
                                            modal.show();
                                        }, 300);

                                    } else {
                                        console.log('‚ö†Ô∏è Ticket no encontrado despu√©s del filtro');
                                        Swal.fire({
                                            title: 'Ticket filtrado',
                                            text: `Se aplic√≥ el filtro para el ticket ${ticketId}. Revisa la tabla de tickets.`,
                                            icon: 'info',
                                            confirmButtonText: 'Entendido'
                                        });
                                    }
                                }, 1500);

                            } else {
                                console.log('‚ÑπÔ∏è Notificaci√≥n sin ticket asociado');
                                Swal.fire({
                                    title: 'Notificaci√≥n',
                                    text: 'Esta notificaci√≥n no tiene un ticket asociado.',
                                    icon: 'info',
                                    confirmButtonText: 'Entendido'
                                });
                            }
                        } else {
                            UI.handleError(new Error(response.message || 'Error al marcar notificaci√≥n como le√≠da.'));
                        }
                    },
                    error => {
                        console.error('‚ùå Error al marcar notificaci√≥n:', error);
                        UI.handleError(error);
                    }
                );
            } else {
                console.log('‚ùå No se encontr√≥ elemento de notificaci√≥n clickeado');
                console.log('üîç Elemento clickeado:', event.target);
            }
        }
    };
</script>