<script>
    // ===============================================================
    // 3. API (ComunicaciÃ³n con el Servidor)
    // ===============================================================

    const API = {
        /**
         * ðŸ”§ FUNCIÃ“N CORREGIDA: Ejecuta una funciÃ³n del servidor con sistema robusto de loading
         * @param {string} functionName - Nombre de la funciÃ³n de Apps Script a ejecutar.
         * @param {any} args - Argumentos para la funciÃ³n del servidor.
         * @param {function} successHandler - Callback para Ã©xito.
         * @param {function} failureHandler - Callback para fallo.
         * @param {number} [retries=3] - NÃºmero de reintentos.
         * @param {number} [delay=1000] - Retraso inicial entre reintentos en ms.
         */
        runServerFunction(functionName, args, successHandler, failureHandler, retries = 3, delay = 1000) {
            console.log(`ðŸ”„ Ejecutando funciÃ³n del servidor: ${functionName}`);

            const attempt = (currentRetry) => {
                try {
                    google.script.run
                        .withSuccessHandler(response => {
                            console.log(`âœ… Ã‰xito en ${functionName}:`, response);
                            LoadingManager.hide();
                            successHandler(response);
                        })
                        .withFailureHandler(error => {
                            console.error(`âŒ Error en ${functionName}:`, error);

                            if (currentRetry > 0 && (
                                error.message.includes('Service invoked too many times') ||
                                error.message.includes('Network error') ||
                                error.message.includes('timeout')
                            )) {
                                console.warn(`ðŸ”„ Reintentando ${functionName} en ${delay}ms... (${currentRetry} reintentos restantes)`);
                                setTimeout(() => attempt(currentRetry - 1), delay);
                                delay *= 2; // Backoff exponencial
                            } else {
                                LoadingManager.hide();
                                failureHandler(error);
                            }
                        })[functionName](args);

                } catch (syncError) {
                    console.error(`ðŸ’¥ Error sincrÃ³nico en ${functionName}:`, syncError);
                    LoadingManager.hide();
                    failureHandler(syncError);
                }
            };

            attempt(retries);
        }
    };
</script>